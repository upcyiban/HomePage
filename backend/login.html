<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>石大易班后台管理登陆页</title>
    <link rel="stylesheet" href="main.css">
    <style>
        body{
            display:flex;
            align-items:center;
            justify-content:center;
        }
    </style>
</head>
<body>
    
    <div class="form">
        <h1>登陆</h1>
        <input type="text" name="username" placeholder="用户名 ：">
        <input type="password" name="password" placeholder="密码 ：">
        <div class="sub-btn" id="submit-btn">登陆</div>
    </div>
    <div class="msg-bar-hidden" id="msg-bar">请稍后</div>
    <script>
        const BACKEND_ROOT_URL     = 'http://localhost:8080'
        const BACKEND_LOGIN        = `${BACKEND_ROOT_URL}/homepage/login`
        const BACKEND_LOGIN_CHECK  = `${BACKEND_ROOT_URL}/homepage/login/check`
        const BACKEND_IMAGE_UPLOAD = `${BACKEND_ROOT_URL}/homepage/image`
        const BACKEND_DATA_SUBMIT  = `${BACKEND_ROOT_URL}/homepage/data`
        
        let msgBar = {
            _msgBar : document.querySelector('#msg-bar'),
            infoBg  : '#90BEF9',
            warnBg  : '#FF6868',
            succBg  : '#00FEB0',
            show(msg,bg){
                this._msgBar.innerHTML = msg
                console.log(this._msgBar.style.backgroud )
                this._msgBar.style.background = bg
                if(!this._msgBar.classList.contains('msg-bar-active')){
                    this._msgBar.classList.add('msg-bar-active')
                }
                setTimeout(()=>{
                    this._msgBar.classList.remove('msg-bar-active')
                },3000)
            },
            info(msg){
                this.show(msg,this.infoBg)
            },
            warn(msg){
                this.show(msg,this.warnBg)
            },
            success(msg){
                this.show(msg,this.succBg)
            }
        }
        // console.log(msgBar)
        function judgeLogin(){
            fetch(BACKEND_LOGIN_CHECK,{
                credentials: 'include'
            }).then(res => 
                res.json()
            ).then(msg => {
                if (msg.code == 1){
                    location.href = "index.html"
                }
            }).catch(err => 
                console.error(err)
            )
        }

        function loginSubmit(){
            let usname = document.querySelector('input[name=username]')
                let pwd =  document.querySelector('input[name=password]')
                let data = {
                    username : usname.value,
                    password      : pwd.value
                }
            // console.log(data)
                msgBar.info('正在登录')
                fetch(BACKEND_LOGIN,{
                    method:'POST',
                    credentials: 'include',
                    body: JSON.stringify(data)
                }).then(res => 
                    res.json()
                ).then(msg => {
                    if (msg.code == 1){
                        msgBar.success('登陆成功')
                        judgeLogin()
                    }else{
                        msgBar.warn(msg.message)
                        usname.value = ""
                        pwd.value = ""
                    }
                }).catch(err => {
                    console.error(err)
                })
        }

        function handleSubmit(){
            let subBtn = document.querySelector('#submit-btn')
            subBtn.addEventListener('click',loginSubmit)
            document.onkeypress = (e)=>{
                if (e.keyCode == 13){
                    loginSubmit()
                }
            }
        }
        function start(){
            judgeLogin()
            handleSubmit()
        }
        start()
    </script>
</body>
</html>